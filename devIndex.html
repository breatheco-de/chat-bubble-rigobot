<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rigobot Bubble</title>
  </head>
  <body style="height: 300vh">
    <h1 id="chat-grow">s</h1>
    <button onclick="moveRigo()">Move RIgo</button>
    <button onclick="askRigobot()">Ask Rigobot</button>
    <button onclick="completeRigobot()">Complete Rigobot</button>
    <button onclick="useTemplateRigobot()">Use Template Rigobot</button>
    <button onclick="stopGeneration()">Stop Generation</button>
    <button onclick="tryRigobot()">Try Rigobot</button>
    <button onclick="closeRigobot()">Close Rigobot</button>
    <button onclick="runAgentLoop()">Run Agent Loop</button>
    <button onclick="stopAgentLoop()">Stop Agent Loop</button>
    <button onclick="runLearnpackAgent()">Run Agent (v2 learnpack)</button>
    <button onclick="stopLearnpackAgent()">Stop Agent (v2 learnpack)</button>
    <button onclick="changeBgColor()">Change Background Color</button>
    <input type="color" id="colorPicker" value="#ffffff" style="margin-left: 10px;" />
    <div id="chat-target">
      <h1>An H1 in the target</h1>
    </div>
    <div id="agent-messages" style="margin: 20px; padding: 10px; border: 1px solid #ccc; min-height: 100px; background-color: #f5f5f5; max-width: 600px;">
      <h3>Agent Chat</h3>
      <div id="agent-content" style="height: 300px; overflow-y: auto; margin-bottom: 10px; padding: 10px; background-color: #fff; border: 1px solid #ddd; border-radius: 5px;"></div>
      <div style="display: flex; gap: 10px;">
        <input 
          type="text" 
          id="agent-input" 
          placeholder="Type your message here..."
          style="flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 5px; font-size: 14px;"
          onkeypress="if(event.key === 'Enter') sendAgentMessage()"
        />
        <button 
          onclick="sendAgentMessage()" 
          style="padding: 8px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;"
        >
          Send
        </button>
      </div>
    </div>

    <div
      style="position: absolute; top: 3000px; right: 50%"
      id="bottom-element"
    >
      asdasd
    </div>
    <script type="module" src="/src/main.tsx"></script>

    <script>
      let job = null;
      let agentJob = null;
      let learnpackAgentJob = null;
      let conversationHistory = [];
      let baseTask = "You are a helpful assistant that can change the background color of this webpage. When the user asks you to change the background color, use the changeBackgroundColor tool with an appropriate color. Make sure to provide friendly responses and confirm when the color has been changed. You can also answer questions and have a conversation with the user.";

      async function changeBackgroundColor(args) {
        console.log("changeBackgroundColor", args);
        const color = args.color;
        return new Promise((resolve) => {
          document.body.style.backgroundColor = color;
          setTimeout(() => {
            resolve(`Background color changed to ${color} successfully`);
          }, 100);
        });
      }

      function addMessageToChat(content, isUser = false) {
        const agentContentDiv = document.querySelector("#agent-content");
        if (!agentContentDiv) return;

        const messageDiv = document.createElement("div");
        messageDiv.style.padding = "10px";
        messageDiv.style.margin = "5px 0";
        messageDiv.style.backgroundColor = isUser ? "#e3f2fd" : "#fff";
        messageDiv.style.borderRadius = "5px";
        messageDiv.style.borderLeft = `3px solid ${isUser ? "#2196f3" : "#4caf50"}`;
        
        const label = isUser ? "You" : "Assistant";
        messageDiv.innerHTML = `<strong>${label}:</strong> ${content}`;
        
        agentContentDiv.appendChild(messageDiv);
        agentContentDiv.scrollTop = agentContentDiv.scrollHeight;
      }

      function addJsonToChat(obj, label = "AgentRun") {
        const agentContentDiv = document.querySelector("#agent-content");
        if (!agentContentDiv) return;

        const wrapper = document.createElement("div");
        wrapper.style.padding = "10px";
        wrapper.style.margin = "5px 0";
        wrapper.style.backgroundColor = "#fff";
        wrapper.style.borderRadius = "5px";
        wrapper.style.borderLeft = "3px solid #9c27b0";

        const title = document.createElement("div");
        title.innerHTML = `<strong>${label}:</strong>`;
        title.style.marginBottom = "6px";

        const pre = document.createElement("pre");
        pre.style.whiteSpace = "pre-wrap";
        pre.style.wordBreak = "break-word";
        pre.style.margin = "0";
        pre.style.fontSize = "12px";
        pre.textContent = JSON.stringify(obj, null, 2);

        wrapper.appendChild(title);
        wrapper.appendChild(pre);
        agentContentDiv.appendChild(wrapper);
        agentContentDiv.scrollTop = agentContentDiv.scrollHeight;
      }

      function runAgentLoop(userMessage = null) {
        const agentContentDiv = document.querySelector("#agent-content");
  

        if (userMessage) {
          conversationHistory.push({ role: "user", content: userMessage });
        }

        const changeBgTool = window.rigo.convertTool(
          changeBackgroundColor,
          "changeBackgroundColor",
          "Changes the background color of the webpage. Accepts color names (like 'red', 'blue', 'green') or hex codes (like '#FF5733', '#3498db').",
          {
            color: {
              type: "string",
              description: "The color to set as the background. Can be a color name (e.g., 'red', 'blue', 'green', 'yellow', 'purple', 'orange', 'pink', 'cyan') or a hex code (e.g., '#FF5733', '#3498db', '#2ecc71').",
            },
          }
        );

        let task = baseTask;
        if (conversationHistory.length > 0) {
          const conversationContext = conversationHistory.map(msg => `${msg.role}: ${msg.content}`).join("\n");
          task += `\n\nConversation history:\n${conversationContext}\n\nPlease respond to the user's latest message and continue the conversation.`;
        }

        agentJob = window.rigo.agentLoop({
          task: task,
          context: "You are running in a web browser. The user can interact with you to change the page background color or ask questions.",
          tools: [changeBgTool],
          onMessage: (message) => {
            const content = message.content || (typeof message === "string" ? message : JSON.stringify(message));
            if (content && typeof content === "string" && content.trim()) {
              addMessageToChat(content, false);
              conversationHistory.push({ role: "assistant", content: content });
            }
            console.log("Agent message:", message);
          },
          onComplete: (success, data) => {
            console.log("Agent loop completed:", success, data);
          },
        });

        agentJob.run();
      }

      function sendAgentMessage() {
        const input = document.querySelector("#agent-input");
        if (!input) return;

        const message = input.value.trim();
        if (!message) return;

        addMessageToChat(message, true);
        input.value = "";

        if (!agentJob && conversationHistory.length === 0) {
          addMessageToChat("Starting agent loop...", false);
        }

        runAgentLoop(message);
      }

      function stopAgentLoop() {
        if (agentJob) {
          agentJob.stop();
          agentJob = null;
          const agentContentDiv = document.querySelector("#agent-content");
          if (agentContentDiv) {
            const stopDiv = document.createElement("div");
            stopDiv.style.padding = "10px";
            stopDiv.style.margin = "5px 0";
            stopDiv.style.backgroundColor = "#fff3cd";
            stopDiv.style.borderRadius = "5px";
            stopDiv.style.border = "1px solid #ffeeba";
            stopDiv.innerHTML = "<strong>Agent Loop Stopped by user</strong>";
            agentContentDiv.appendChild(stopDiv);
          }
          console.log("Agent loop stopped");
        }
      }

      function runLearnpackAgent() {
        const slug = window.prompt("Enter the learnpack agent slug to run (v2/learnpack/agent/<slug>/):");
        if (!slug) return;

        const defaultPayload = "{}";
        const rawPayload = window.prompt(
          "Paste JSON payload for the agent (leave as {} to test connectivity):",
          defaultPayload
        );

        let payload = {};
        try {
          payload = rawPayload ? JSON.parse(rawPayload) : {};
        } catch (e) {
          addMessageToChat("Invalid JSON payload. Please try again.", false);
          return;
        }

        addMessageToChat(`Starting learnpack agent: ${slug}`, false);

        learnpackAgentJob = window.rigo.agent({
          slug,
          payload,
          onEvent: (event) => {
            if (!event || !event.type) return;
            if (event.type === "error") {
              addMessageToChat(`ERROR: ${event.data?.m || event.data?.error || "Unknown error"}`, false);
              return;
            }
            addMessageToChat(event.data?.m || `[${event.type}]`, false);

            // NEW: dump full AgentRun details whenever available
            if (event.data?.agent_run) {
              addJsonToChat(event.data.agent_run, `AgentRun (${event.type})`);
            }
          },
          onComplete: (success, data) => {
            console.log("Learnpack agent completed:", success, data);
          },
        });

        learnpackAgentJob.run();
      }

      function stopLearnpackAgent() {
        if (learnpackAgentJob) {
          learnpackAgentJob.stop();
          learnpackAgentJob = null;
          addMessageToChat("Learnpack agent stopped by user", false);
          console.log("Learnpack agent stopped");
        }
      }

      function changeBgColor() {
        const colorPicker = document.querySelector("#colorPicker");
        if (colorPicker) {
          const color = colorPicker.value;
          changeBackgroundColor(color);
          console.log(`Background color changed to ${color}`);
        }
      }

      function moveRigo() {
        const possibilities = [
          ".bottom-left-element",
          null,
          ".centered-element",
          "some-non-existing-element",
          "#bottom-element",
        ];

        const randomIndex = Math.floor(Math.random() * possibilities.length);

        const randomElement = possibilities[randomIndex];
        window.rigo.updateOptions({
          target: randomElement,
          user: {
            token: "some user token ",
          },
        });
      }

      function askRigobot() {
        const target = document.querySelector("#chat-target");
        job = window.rigo.ask({
          prompt: "How can I start learning AI?",
          target: target,
          format: "html",
          onComplete: (data) => {
            console.log("onComplete", data);
          },
        });

        job?.run();
      }

      function stopGeneration() {
        job?.stop();
      }

      async function completeRigobot() {
        const target = document.querySelector("#chat-target");

        const prompt = await window.prompt("Enter a name");
        job = window.rigo.complete({
          templateSlug: "testing-prompt",
          payload: {
            user_name: prompt,
          },

          target: target,
          format: "html",
          onComplete: (success, data) => {
            console.log("onComplete", success, data);
          },
        });

        job?.run();
      }

      async function useTemplateRigobot() {
        const target = document.querySelector("#chat-target");

        const prompt = await window.prompt("Enter a name");
        job = window.rigo.use_template({
          templateSlug: "testing-prompt",
          payload: {
            user_name: prompt,
          },
          target: target,
          format: "html",
          onStart: (data) => {
            console.log("Template completion started:", data);
          },
          onComplete: (success, data) => {
            console.log("onComplete", success, data);
          },
        });

        job?.run();
      }

      function tryRigobot(targetId) {
        window.rigo.updateOptions({
          showBubble: true,
          target: targetId,
          highlight: true,
          welcomeMessage: "Hello my broder!",
          collapsed: false,

          purposeSlug: "4geekscom-public-agent",
        });
      }

      function closeRigobot() {
        window.rigo.updateOptions({
          showBubble: false,
          collapsed: true,
        });
      }
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        if (window.rigo) {
          // window.rigo.init("248b53865d6743519ef55b4ec65772a7", {
          window.rigo.init("4ce70b0f716543c3a97a9078e79ba785", {
            loglevel: "debug",
            purposeSlug: "4geekscom-public-agent",
            completions: [
              {
                prompt: "What is the name of the Data Science main director?",
                answer: "The Data Science main director is Jenniffer Guzman",
                DOMTarget: "#chat-grow",
              },
            ],
            // socketHost: "http://127.0.0.1:8003",

            // socketHost: "http://127.0.0.1:8003",
            context: "The user is called: LulÃº",
            user: {
              token: "0e2137217a1814f69c5619dc8371c428d4b4ada8",
            },
            pusherKey: "085fabde5864ef790a61",
            pusherCluster: "mt1",
            // apiHost: "http://localhost:8001",
            apiHost: "https://rigobot.herokuapp.com",
          });

          window.rigo.show({
            // target: "#bottom-element",
            showBubble: false,
            collapsed: true,
            highlight: true,
          });

          window.rigo.on("open_bubble", (data) => {
            console.log("open_bubble", data);
          });

          window.rigo.on("incoming_message", (data) => {
            console.log("incoming_message", data);
          });

          window.rigo.on("outgoing_message", (data) => {
            console.log("outgoing_message", data);
          });

          window.rigo.on("close_bubble", (data) => {
            console.log("close_bubble", data);
          });

          // window.rigo.hide();
        } else {
          console.error("window.rigo is not defined");
        }
      });
    </script>
  </body>
</html>
